<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Absen Digital Anggota Dapur PPSQ Asy Syadzily 1</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#6C5CE7;       /* ungu elegan */
    --brand-2:#00C2A8;     /* teal cerah */
    --brand-3:#F7B500;     /* kuning aksen */
    --bg:#0f1226;          /* gelap elegan (bukan hitam) */
    --card:#161a39;
    --soft:#8E9AF0;
    --danger:#ef4444;
  }
  html,body{background:var(--bg); color:#e5e7eb; font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  /* Glow gradient background */
  .glow:before{
    content:"";
    position:absolute; inset:-60px;
    background: radial-gradient(800px 400px at 20% 0%, rgba(108,92,231,.25), transparent 60%),
                radial-gradient(800px 400px at 80% 40%, rgba(0,194,168,.18), transparent 60%),
                radial-gradient(600px 320px at 50% 100%, rgba(247,181,0,.18), transparent 60%);
    filter: blur(40px);
    z-index:-1;
  }
  /* Pretty switches */
  .pill{
    position:relative; display:inline-flex; align-items:center; gap:.5rem;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    padding:.4rem; border-radius:999px;
  }
  .pill button{
    border-radius:999px; padding:.4rem .9rem; font-weight:600;
  }
  .pill .active{
    background:linear-gradient(135deg, var(--brand), var(--brand-2));
    color:white; box-shadow:0 8px 24px rgba(108,92,231,.35), inset 0 0 0 1px rgba(255,255,255,.15);
  }
  /* Attendance chips */
  .chip{ border-radius:999px; padding:.35rem .7rem; font-weight:700; cursor:pointer; transition:all .18s ease; border:1px solid rgba(255,255,255,.08)}
  .chip:hover{ transform:translateY(-1px); }
  .chip.selected{ box-shadow:0 8px 24px rgba(0,0,0,.25), inset 0 0 0 2px rgba(255,255,255,.15)}
  .chip-hadir{ background:rgba(0,194,168,.18); color:#8FF4E7 }
  .chip-alpha{ background:rgba(239,68,68,.18); color:#fecaca; animation:shake .3s ease-in-out }
  .chip-sakit{ background:rgba(247,181,0,.18); color:#FDE68A }
  .chip-izin{ background:rgba(108,92,231,.18); color:#c7d2fe }
  @keyframes shake{
    10%{ transform:translateX(-2px) rotate(-1deg) }
    20%{ transform:translateX( 2px) rotate( 1deg) }
    30%{ transform:translateX(-2px) rotate(-1deg) }
    40%{ transform:translateX( 2px) rotate( 1deg) }
  }
  /* Row hover */
  .row:hover{ background:rgba(255,255,255,.03) }
  /* Card glass */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.1);
    border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  /* Avatar */
  .avatar{
    width:42px; height:42px; border-radius:999px; overflow:hidden; display:grid; place-items:center;
    border:2px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  }
  .avatar img{ width:100%; height:100%; object-fit:cover }
  .avatar span{ font-weight:800; color:#fff }
  /* Print */
  @media print{
    body{ background:white; color:#111827 }
    .no-print{ display:none !important }
    .card{ box-shadow:none; border:1px solid #e5e7eb; background:white }
    .chip{ border:1px solid #e5e7eb }
  }
</style>
</head>
<body>
  <div class="relative glow min-h-screen">
    <header class="max-w-7xl mx-auto px-6 pt-10">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
            absen digital anggota dapur ppsq asy Syadzily 1
          </h1>
          <p class="text-slate-300 mt-2">Ditandatangani ketua bidang, <span class="font-semibold text-white">Al Ghifary</span></p>
        </div>
        <div class="flex flex-wrap items-center gap-3 no-print">
          <div class="pill">
            <button id="btnViewer" class="active">Viewer</button>
            <button id="btnAdmin">Admin</button>
          </div>
          <input id="datePicker" type="date" class="bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white" />
          <div class="pill">
            <button id="btnHari" class="active">Hari Ini</button>
            <button id="btnMinggu">Mingguan</button>
          </div>
          <button id="btnPrint" class="bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] text-white font-semibold px-4 py-2 rounded-xl shadow-lg hover:opacity-95 active:scale-[.98]">
            Cetak Rekap
          </button>
        </div>
      </div>
      <div class="mt-6 grid md:grid-cols-3 gap-4">
        <div class="card p-4">
          <div class="text-sm text-slate-300">Tanggal dipilih</div>
          <div id="infoTanggal" class="text-xl font-bold mt-1"></div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-300">Status mode</div>
          <div id="infoMode" class="text-xl font-bold mt-1">Viewer (hanya lihat)</div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-300">Total anggota</div>
          <div id="infoAnggota" class="text-xl font-bold mt-1">0</div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-10">
      <div class="no-print flex items-center gap-2 mb-6">
        <div class="pill">
          <button id="tabNon" class="active">Non Sekolah</button>
          <button id="tabSekolah">Sekolah</button>
        </div>
        <span class="text-slate-300 text-sm">Kelompok anggota</span>
      </div>

      <section id="sectionHari" class="">
        <div id="panelNon" class="card p-5 mb-8">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-extrabold">Non Sekolah</h2>
            <div class="text-slate-300">Shalat: Subuh • Dzuhur • Ashar • Maghrib • Isya</div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full min-w-[720px]">
              <thead>
                <tr class="text-left text-slate-300 border-b border-white/10">
                  <th class="py-3">Anggota</th>
                  <th class="py-3">Subuh</th>
                  <th class="py-3">Dzuhur</th>
                  <th class="py-3">Ashar</th>
                  <th class="py-3">Maghrib</th>
                  <th class="py-3">Isya</th>
                  <th class="py-3">Foto</th>
                </tr>
              </thead>
              <tbody id="tbodyNon"></tbody>
            </table>
          </div>
        </div>

        <div id="panelSekolah" class="card p-5 mb-8 hidden">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-extrabold">Sekolah</h2>
            <div class="text-slate-300">Shalat: Subuh • Dzuhur • Ashar • Maghrib • Isya</div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full min-w-[720px]">
              <thead>
                <tr class="text-left text-slate-300 border-b border-white/10">
                  <th class="py-3">Anggota</th>
                  <th class="py-3">Subuh</th>
                  <th class="py-3">Dzuhur</th>
                  <th class="py-3">Ashar</th>
                  <th class="py-3">Maghrib</th>
                  <th class="py-3">Isya</th>
                  <th class="py-3">Foto</th>
                </tr>
              </thead>
              <tbody id="tbodySekolah"></tbody>
            </table>
          </div>
        </div>

        <div class="card p-6 mb-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-extrabold">Rekap Harian per Shalat</h3>
            <button id="btnResetHari" class="no-print text-red-300 hover:text-red-200 font-semibold">Reset hari ini</button>
          </div>
          <div id="rekapHarianGrid" class="grid md:grid-cols-3 gap-4"></div>
        </div>

        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-extrabold">Rekap Harian per Anggota</h3>
          </div>
          <div id="rekapHarianAnggota" class="overflow-x-auto">
            <table class="w-full min-w-[680px]">
              <thead>
                <tr class="text-left text-slate-300 border-b border-white/10">
                  <th class="py-3">Anggota</th>
                  <th class="py-3">Hadir</th>
                  <th class="py-3">Alpha</th>
                  <th class="py-3">Sakit</th>
                  <th class="py-3">Izin</th>
                </tr>
              </thead>
              <tbody id="tbodyHarianAnggota"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="sectionMinggu" class="hidden">
        <div class="card p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <h3 class="text-xl font-extrabold">Rekap Total Mingguan</h3>
            <div class="no-print flex items-center gap-3">
              <label class="text-slate-300">Mulai Minggu:</label>
              <input id="weekStart" type="date" class="bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white" />
              <button id="btnHitungMinggu" class="bg-white/10 border border-white/10 px-4 py-2 rounded-xl hover:bg-white/20">Hitung</button>
            </div>
          </div>

          <div id="rekapMingguWrap" class="grid lg:grid-cols-2 gap-6">
            <div class="p-4 rounded-xl border border-white/10 bg-white/5">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold">Non Sekolah</h4>
                <span id="sumNon" class="text-slate-300 text-sm">-</span>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full min-w-[680px]">
                  <thead>
                    <tr class="text-left text-slate-300 border-b border-white/10">
                      <th class="py-3">Anggota</th>
                      <th class="py-3">Hadir</th>
                      <th class="py-3">Alpha</th>
                      <th class="py-3">Sakit</th>
                      <th class="py-3">Izin</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyWeekNon"></tbody>
                </table>
              </div>
            </div>
            <div class="p-4 rounded-xl border border-white/10 bg-white/5">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold">Sekolah</h4>
                <span id="sumSekolah" class="text-slate-300 text-sm">-</span>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full min-w-[680px]">
                  <thead>
                    <tr class="text-left text-slate-300 border-b border-white/10">
                      <th class="py-3">Anggota</th>
                      <th class="py-3">Hadir</th>
                      <th class="py-3">Alpha</th>
                      <th class="py-3">Sakit</th>
                      <th class="py-3">Izin</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyWeekSekolah"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="mt-6 text-slate-300">
            Catatan: Perhitungan mingguan menjumlahkan semua shalat (5 waktu) selama 7 hari sejak tanggal mulai.
          </div>
        </div>
      </section>
    </main>

    <footer class="max-w-7xl mx-auto px-6 pb-12">
      <div class="card p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <div class="font-bold">Tertandatangani:</div>
          <div class="text-white text-lg font-extrabold">Al Ghifary</div>
          <div class="text-slate-300">Ketua Bidang</div>
        </div>
        <div class="text-slate-400">Data disimpan di perangkat Anda (local). Gunakan Cetak untuk membagikan rekap.</div>
      </div>
    </footer>
  </div>

  <div id="adminModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
    <div class="card p-6 w-full max-w-md bg-[var(--card)]">
      <h3 class="text-xl font-extrabold mb-2">Masuk sebagai Admin</h3>
      <p class="text-slate-300 mb-4">Masukkan PIN admin untuk mengedit data.</p>
      <input id="adminPinInput" type="password" class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white mb-4" placeholder="PIN Admin" />
      <div class="flex flex-col gap-3">
        <div class="flex justify-end gap-3">
          <button id="cancelAdmin" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Batal</button>
          <button id="confirmAdmin" class="px-4 py-2 rounded-xl bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] font-semibold">Masuk</button>
        </div>
        <button id="forgotPin" class="text-left text-sky-300 hover:text-sky-200">Lupa PIN?</button>
      </div>

    </div>
  </div>

  <div id="fotoModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
    <div class="card p-6 w-full max-w-lg bg-[var(--card)]">
      <h3 class="text-xl font-extrabold mb-2">Tambah/Ubah Foto Anggota</h3>
      <p class="text-slate-300 mb-4">Pilih anggota lalu unggah foto. Foto disimpan di perangkat Anda.</p>
      <div class="grid md:grid-cols-2 gap-3 mb-4">
        <select id="fotoAnggotaSelect" class="bg-white/10 border border-white/10 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white"></select>
        <input id="fotoFile" type="file" accept="image/*" class="bg-white/10 border border-white/10 rounded-xl px-4 py-2 text-slate-200" />
      </div>
      <div class="flex items-center gap-3 mb-4">
        <button id="btnHapusFoto" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-red-300">Hapus Foto</button>
        <button id="btnSimpanFoto" class="px-4 py-2 rounded-xl bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] font-semibold">Simpan Foto</button>
        <div class="flex-1"></div>
        <button id="btnTutupFoto" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Tutup</button>
      </div>
      <div id="previewFoto" class="rounded-xl overflow-hidden border border-white/10 bg-white/5 grid place-items-center h-48 text-slate-300">
        Pratinjau foto akan muncul di sini
      </div>
    </div>
  </div>

  <div class="no-print fixed bottom-6 right-6 z-40">
    <div id="adminFab" class="hidden">
      <div class="card p-4 bg-[var(--card)]">
        <div class="flex flex-col gap-2">
          <button id="openAnggotaModal" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Kelola Anggota</button>
          <button id="openFotoModal" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Kelola Foto Anggota</button>
          <button id="exportData" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Ekspor Data</button>
          <button id="importData" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Impor Data</button>
          <button id="changePin" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Ubah PIN Admin</button>
          <button id="logoutAdmin" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left text-red-300">Keluar Admin</button>
        </div>
      </div>
    </div>
    <button id="fabToggle" class="rounded-full bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] w-14 h-14 shadow-xl grid place-items-center hover:opacity-95 active:scale-[.98]">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 13a1 1 0 0 1-1-1V6.5a1 1 0 1 1 2 0V12a1 1 0 0 1-1 1Zm0 4.75a1.25 1.25 0 1 1 0-2.5 1.25 1.25 0 0 1 0 2.5Z"/></svg>
    </button>
  </div>

  <div id="anggotaModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
    <div class="card p-6 w-full max-w-lg bg-[var(--card)]">
      <h3 class="text-xl font-extrabold mb-2">Kelola Anggota</h3>
      <p class="text-slate-300 mb-4">Tambah atau hapus anggota dari daftar.</p>
      
      <div class="flex flex-col gap-4">
        <div class="p-4 rounded-xl border border-white/10 bg-white/5">
          <h4 class="font-bold mb-2">Tambah Anggota</h4>
          <input id="anggotaNamaTambah" type="text" class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none text-white mb-2" placeholder="Nama Anggota (huruf kecil)" />
          <div class="flex items-center gap-2">
            <select id="anggotaGrupTambah" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none text-white">
              <option value="non">Non Sekolah</option>
              <option value="sekolah">Sekolah</option>
            </select>
            <button id="btnTambahAnggota" class="px-4 py-2 rounded-xl bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] font-semibold">Tambah</button>
          </div>
        </div>
        <div class="p-4 rounded-xl border border-white/10 bg-white/5">
          <h4 class="font-bold mb-2">Hapus Anggota</h4>
          <p class="text-sm text-red-300 mb-2">Perhatian: Menghapus anggota akan menghapus semua data absen dan fotonya.</p>
          <select id="anggotaNamaHapus" class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none text-white mb-2"></select>
          <button id="btnHapusAnggota" class="px-4 py-2 rounded-xl w-full bg-red-600 hover:bg-red-700 font-semibold">Hapus</button>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-4">
        <button id="btnTutupAnggota" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    /* ======================= Data & Storage Helpers ======================= */
    const PRAYERS = ["subuh","dzuhur","ashar","maghrib","isya"];
    const STATUS = ["hadir","alpha","sakit","izin"];

    const sKey = {
      pin: "absen_pin",
      photos: "absen_foto_map",
      daily: "absen_daily", // { 'YYYY-MM-DD': { 'nama': { subuh:'hadir', ... } } }
      groups: "absen_groups" // NEW: Store groups
    };

    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      }catch(e){
        console.error("Error parsing JSON for key", key, e);
        return fallback;
      }
    }

    function saveJSON(key, data){
      localStorage.setItem(key, JSON.stringify(data));
    }
    
    // Initial data load
    let pin = loadJSON(sKey.pin, '9999');
    let dailyData = loadJSON(sKey.daily, {});
    let photoMap = loadJSON(sKey.photos, {});
    let groups = loadJSON(sKey.groups, {
      non: ["ahmad", "al ghifary", "ali", "arif", "bima", "daffa", "faris", "faqih", "gading", "habib", "rizal", "syahrul", "wahyu"],
      sekolah: ["adit", "agus", "aziz", "bachtiar", "dani", "eko", "fajar", "gilang", "hasan", "ihsan", "joko", "kiki", "lutfi", "maulana", "nurul", "rehan", "ridho", "sugeng", "surya", "tegar", "yudi"]
    });
    
    let currentDate = new Date();
    let isAdmin = false;
    let showWeekly = false;
    let currentGroup = 'non';
    let weeklySummary = {}; // cache for weekly summary

    /* ======================= DOM Elements ======================= */
    const infoTanggal = document.getElementById("infoTanggal");
    const infoMode = document.getElementById("infoMode");
    const infoAnggota = document.getElementById("infoAnggota");

    const btnViewer = document.getElementById("btnViewer");
    const btnAdmin = document.getElementById("btnAdmin");
    
    const datePicker = document.getElementById("datePicker");

    const btnHari = document.getElementById("btnHari");
    const btnMinggu = document.getElementById("btnMinggu");

    const sectionHari = document.getElementById("sectionHari");
    const sectionMinggu = document.getElementById("sectionMinggu");

    const tabNon = document.getElementById("tabNon");
    const tabSekolah = document.getElementById("tabSekolah");
    const panelNon = document.getElementById("panelNon");
    const panelSekolah = document.getElementById("panelSekolah");

    const tbodyNon = document.getElementById("tbodyNon");
    const tbodySekolah = document.getElementById("tbodySekolah");
    const tbodyHarianAnggota = document.getElementById("tbodyHarianAnggota");

    const rekapHarianGrid = document.getElementById("rekapHarianGrid");
    const btnResetHari = document.getElementById("btnResetHari");

    const btnPrint = document.getElementById("btnPrint");
    const weekStart = document.getElementById("weekStart");
    const btnHitungMinggu = document.getElementById("btnHitungMinggu");
    const tbodyWeekNon = document.getElementById("tbodyWeekNon");
    const tbodyWeekSekolah = document.getElementById("tbodyWeekSekolah");
    const sumNon = document.getElementById("sumNon");
    const sumSekolah = document.getElementById("sumSekolah");

    /* Admin Modal */
    const adminModal = document.getElementById("adminModal");
    const adminPinInput = document.getElementById("adminPinInput");
    const confirmAdmin = document.getElementById("confirmAdmin");
    const cancelAdmin = document.getElementById("cancelAdmin");
    const forgotPin = document.getElementById("forgotPin");

    /* Foto Modal */
    const fotoModal = document.getElementById("fotoModal");
    const fotoAnggotaSelect = document.getElementById("fotoAnggotaSelect");
    const fotoFile = document.getElementById("fotoFile");
    const previewFoto = document.getElementById("previewFoto");
    const btnSimpanFoto = document.getElementById("btnSimpanFoto");
    const btnTutupFoto = document.getElementById("btnTutupFoto");
    const btnHapusFoto = document.getElementById("btnHapusFoto");

    /* Admin menu */
    const adminFab = document.getElementById("adminFab");
    const fabToggle = document.getElementById("fabToggle");
    const openAnggotaModal = document.getElementById("openAnggotaModal");
    const openFotoModal = document.getElementById("openFotoModal");
    const exportData = document.getElementById("exportData");
    const importData = document.getElementById("importData");
    const changePin = document.getElementById("changePin");
    const logoutAdmin = document.getElementById("logoutAdmin");

    /* Anggota Modal */
    const anggotaModal = document.getElementById("anggotaModal");
    const anggotaNamaTambah = document.getElementById("anggotaNamaTambah");
    const anggotaGrupTambah = document.getElementById("anggotaGrupTambah");
    const btnTambahAnggota = document.getElementById("btnTambahAnggota");
    const anggotaNamaHapus = document.getElementById("anggotaNamaHapus");
    const btnHapusAnggota = document.getElementById("btnHapusAnggota");
    const btnTutupAnggota = document.getElementById("btnTutupAnggota");

    /* ======================= Date & Formatting ======================= */
    const days = ["Ahad", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    function fmtDate(d) {
      return d.toLocaleDateString('en-CA');
    }

    function fmtDatePretty(d) {
      return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function ymd(d) {
      return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
    }

    /* ======================= UI Functions ======================= */
    function updateUI(){
      // Header Info
      infoTanggal.textContent = fmtDatePretty(currentDate);
      datePicker.value = ymd(currentDate);
      infoAnggota.textContent = `${groups.non.length + groups.sekolah.length} Anggota`;

      // Tab & Section visibility
      sectionHari.classList.toggle('hidden', showWeekly);
      sectionMinggu.classList.toggle('hidden', !showWeekly);
      btnHari.classList.toggle('active', !showWeekly);
      btnMinggu.classList.toggle('active', showWeekly);
      
      if(!showWeekly){
        panelNon.classList.toggle('hidden', currentGroup !== 'non');
        panelSekolah.classList.toggle('hidden', currentGroup !== 'sekolah');
        tabNon.classList.toggle('active', currentGroup === 'non');
        tabSekolah.classList.toggle('active', currentGroup === 'sekolah');
      }

      // Admin visibility
      btnViewer.classList.toggle('active', !isAdmin);
      btnAdmin.classList.toggle('active', isAdmin);
      infoMode.textContent = isAdmin ? 'Admin (bisa edit)' : 'Viewer (hanya lihat)';

      // Disable chips if not admin
      document.querySelectorAll('.chip').forEach(chip => {
        chip.disabled = !isAdmin;
        chip.style.pointerEvents = isAdmin ? 'auto' : 'none';
        chip.style.opacity = isAdmin ? 1 : 0.6;
        chip.style.cursor = isAdmin ? 'pointer' : 'default';
      });

      // Hide reset button if not admin
      btnResetHari.classList.toggle('hidden', !isAdmin);
      
      adminFab.classList.toggle('hidden', !isAdmin);
    }
    
    function renderTable(group, tbody, daily) {
      tbody.innerHTML = groups[group].map(m => {
        const rowData = daily?.[m] || {};
        const photo = photoMap[m] || 'no-photo';
        const photoSrc = photo === 'no-photo' ? 'https://via.placeholder.com/150/1f2937/d1d5db?text=...' : photo;
        const photoAlt = photo === 'no-photo' ? 'Tidak ada foto' : `Foto ${m}`;

        return `<tr class="border-b border-white/5 last:border-0 row">
          <td class="py-3 pr-4 flex items-center gap-3">
            <div class="avatar flex-shrink-0">
              ${photo !== 'no-photo' ? `<img src="${photoSrc}" alt="${photoAlt}" />` : `<span class="text-xs">${m.slice(0, 2).toUpperCase()}</span>`}
            </div>
            <span class="font-bold capitalize">${m}</span>
          </td>
          ${PRAYERS.map(p => {
            const status = rowData[p] || 'alpha';
            const isSelected = status !== 'alpha';
            return `<td class="py-3 pr-4">
              <button data-member="${m}" data-prayer="${p}" data-status="${status}" class="chip chip-${status} ${isSelected ? 'selected' : ''}">
                ${status}
              </button>
            </td>`;
          }).join('')}
          <td class="py-3 pr-4">
            <button class="chip chip-izin" onclick="showFotoModal('${m}')">
                Lihat
            </button>
          </td>
        </tr>`;
      }).join('');
    }

    function renderDailySummary(daily) {
        const allMembers = [...groups.non, ...groups.sekolah].sort();
        
        rekapHarianGrid.innerHTML = STATUS.map(status => {
            const total = allMembers.filter(m => {
                const rowData = daily[m] || {};
                return PRAYERS.some(p => rowData[p] === status);
            }).length;
            return `
                <div class="p-4 rounded-xl border border-white/10 bg-white/5 flex items-center justify-between">
                    <div class="text-sm text-slate-300 capitalize">${status}</div>
                    <div class="text-xl font-bold">${total}</div>
                </div>
            `;
        }).join('');
    }

    function renderDailyMemberSummary(daily) {
        const allMembers = [...groups.non, ...groups.sekolah].sort();
        const html = allMembers.map(m => {
            const rowData = daily[m] || {};
            const summary = { hadir: 0, alpha: 0, sakit: 0, izin: 0 };
            PRAYERS.forEach(p => {
                summary[rowData[p] || 'alpha']++;
            });
            return `
                <tr class="border-b border-white/5 last:border-0 row">
                    <td class="py-3 pr-4 font-semibold capitalize">${m}</td>
                    ${STATUS.map(s => `
                        <td class="py-3 pr-4 text-center">
                            <span class="font-bold">${summary[s]}</span>
                        </td>
                    `).join('')}
                </tr>
            `;
        }).join('');
        tbodyHarianAnggota.innerHTML = html;
    }

    function renderWeeklyTable(group, tbody) {
      const summary = weeklySummary[group] || {};
      const total = Object.values(summary).reduce((acc, curr) => {
        acc.hadir += curr.hadir;
        acc.alpha += curr.alpha;
        acc.sakit += curr.sakit;
        acc.izin += curr.izin;
        return acc;
      }, { hadir: 0, alpha: 0, sakit: 0, izin: 0 });

      document.getElementById(`sum${group.charAt(0).toUpperCase() + group.slice(1)}`).textContent = `Hadir: ${total.hadir} • Alpha: ${total.alpha} • Sakit: ${total.sakit} • Izin: ${total.izin}`;

      const html = groups[group].map(m => {
        const memberSummary = summary[m] || { hadir: 0, alpha: 0, sakit: 0, izin: 0 };
        return `
          <tr class="border-b border-white/5 last:border-0 row">
            <td class="py-3 pr-4 font-semibold capitalize">${m}</td>
            <td class="py-3 pr-4 text-center">${memberSummary.hadir}</td>
            <td class="py-3 pr-4 text-center">${memberSummary.alpha}</td>
            <td class="py-3 pr-4 text-center">${memberSummary.sakit}</td>
            <td class="py-3 pr-4 text-center">${memberSummary.izin}</td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = html;
    }

    function renderAllTables(){
      const todayData = dailyData[ymd(currentDate)] || {};
      renderTable('non', tbodyNon, todayData);
      renderTable('sekolah', tbodySekolah, todayData);
      renderDailySummary(todayData);
      renderDailyMemberSummary(todayData);
      if(showWeekly) {
        renderWeeklyTable('non', tbodyWeekNon);
        renderWeeklyTable('sekolah', tbodyWeekSekolah);
      }
    }

    function calculateWeeklySummary(start) {
      const summary = { non: {}, sekolah: {} };
      const startDate = new Date(start);
      for(let i = 0; i < 7; i++){
        const date = ymd(new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + i));
        const daily = dailyData[date] || {};
        
        [...groups.non, ...groups.sekolah].forEach(m => {
          if(!summary.non[m]) summary.non[m] = { hadir: 0, alpha: 0, sakit: 0, izin: 0 };
          if(!summary.sekolah[m]) summary.sekolah[m] = { hadir: 0, alpha: 0, sakit: 0, izin: 0 };
          const memberSummary = daily[m] || {};
          PRAYERS.forEach(p => {
            const status = memberSummary[p] || 'alpha';
            if (groups.non.includes(m)) {
                summary.non[m][status]++;
            } else {
                summary.sekolah[m][status]++;
            }
          });
        });
      }
      weeklySummary = summary;
      renderWeeklyTable('non', tbodyWeekNon);
      renderWeeklyTable('sekolah', tbodyWeekSekolah);
    }
    
    function showFotoModal(memberName) {
        fotoModal.classList.remove('hidden');
        fotoModal.classList.add('flex');
        fotoAnggotaSelect.value = memberName;
        updateFotoPreview();
    }
    
    function updateFotoPreview() {
        const memberName = fotoAnggotaSelect.value;
        const photo = photoMap[memberName];
        if (photo) {
            previewFoto.innerHTML = `<img src="${photo}" class="w-full h-full object-cover" alt="Foto ${memberName}" />`;
            btnHapusFoto.classList.remove('hidden');
        } else {
            previewFoto.innerHTML = `<span class="text-slate-300">Pratinjau foto akan muncul di sini</span>`;
            btnHapusFoto.classList.add('hidden');
        }
    }

    /* ======================= Event Listeners ======================= */
    btnViewer.addEventListener('click', () => { isAdmin = false; updateUI(); });
    btnAdmin.addEventListener('click', () => { adminModal.classList.add('flex'); adminModal.classList.remove('hidden'); });

    datePicker.addEventListener('change', (e) => {
      currentDate = new Date(e.target.value);
      renderAllTables();
      updateUI();
    });

    btnHari.addEventListener('click', () => { showWeekly = false; updateUI(); renderAllTables(); });
    btnMinggu.addEventListener('click', () => { showWeekly = true; updateUI(); });

    tabNon.addEventListener('click', () => { currentGroup = 'non'; updateUI(); renderAllTables(); });
    tabSekolah.addEventListener('click', () => { currentGroup = 'sekolah'; updateUI(); renderAllTables(); });

    document.querySelectorAll('#tbodyNon, #tbodySekolah').forEach(tbody => {
      tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('.chip');
        if (!btn || !isAdmin) return;

        const member = btn.dataset.member;
        const prayer = btn.dataset.prayer;
        const currentStatus = btn.dataset.status;

        const dateKey = ymd(currentDate);
        if (!dailyData[dateKey]) {
          dailyData[dateKey] = {};
        }
        if (!dailyData[dateKey][member]) {
          dailyData[dateKey][member] = {};
        }

        const currentIndex = STATUS.indexOf(currentStatus);
        const nextStatus = STATUS[(currentIndex + 1) % STATUS.length];

        dailyData[dateKey][member][prayer] = nextStatus;
        saveJSON(sKey.daily, dailyData);
        renderAllTables();
      });
    });

    btnResetHari.addEventListener('click', () => {
      const dateKey = ymd(currentDate);
      if(confirm(`Yakin ingin mereset data absen untuk tanggal ${fmtDatePretty(currentDate)}?`)) {
        delete dailyData[dateKey];
        saveJSON(sKey.daily, dailyData);
        renderAllTables();
      }
    });

    btnHitungMinggu.addEventListener('click', () => {
      if(!weekStart.value) {
        alert("Pilih tanggal mulai minggu terlebih dahulu.");
        return;
      }
      calculateWeeklySummary(weekStart.value);
    });

    btnPrint.addEventListener('click', () => {
      window.print();
    });

    confirmAdmin.addEventListener('click', () => {
      if(adminPinInput.value === pin){
        isAdmin = true;
        updateUI();
        adminModal.classList.add('hidden');
        adminModal.classList.remove('flex');
        adminPinInput.value = '';
      } else {
        alert('PIN salah!');
      }
    });
    
    cancelAdmin.addEventListener('click', () => {
      adminModal.classList.add('hidden');
      adminModal.classList.remove('flex');
    });

    forgotPin.addEventListener('click', () => {
      const newPin = prompt("Masukkan PIN baru:");
      if (newPin) {
        pin = newPin;
        saveJSON(sKey.pin, pin);
        alert("PIN berhasil diubah. PIN baru Anda adalah: " + newPin);
      }
    });
    
    fabToggle.addEventListener('click', () => {
      adminFab.classList.toggle('hidden');
    });

    logoutAdmin.addEventListener('click', () => {
      isAdmin = false;
      updateUI();
      adminFab.classList.add('hidden');
    });

    openAnggotaModal.addEventListener('click', () => {
      anggotaModal.classList.remove('hidden');
      anggotaModal.classList.add('flex');
      updateAnggotaSelects();
    });

    btnTutupAnggota.addEventListener('click', () => {
      anggotaModal.classList.add('hidden');
      anggotaModal.classList.remove('flex');
    });

    openFotoModal.addEventListener('click', () => {
      fotoModal.classList.remove('hidden');
      fotoModal.classList.add('flex');
      updateAnggotaSelects();
      updateFotoPreview();
    });

    btnTutupFoto.addEventListener('click', () => {
        fotoModal.classList.add('hidden');
        fotoModal.classList.remove('flex');
    });

    fotoAnggotaSelect.addEventListener('change', updateFotoPreview);

    btnSimpanFoto.addEventListener('click', () => {
        const memberName = fotoAnggotaSelect.value;
        const file = fotoFile.files[0];

        if(!memberName || !file){
            alert("Pilih anggota dan foto terlebih dahulu.");
            return;
        }

        const reader = new FileReader();
        reader.onloadend = () => {
            photoMap[memberName] = reader.result;
            saveJSON(sKey.photos, photoMap);
            alert("Foto berhasil disimpan!");
            updateFotoPreview();
            renderAllTables();
        };
        reader.readAsDataURL(file);
    });

    btnHapusFoto.addEventListener('click', () => {
        const memberName = fotoAnggotaSelect.value;
        if(confirm(`Yakin ingin menghapus foto ${memberName}?`)){
            delete photoMap[memberName];
            saveJSON(sKey.photos, photoMap);
            alert("Foto berhasil dihapus.");
            updateFotoPreview();
            renderAllTables();
        }
    });

    btnTambahAnggota.addEventListener('click', () => {
      const nama = anggotaNamaTambah.value.trim().toLowerCase();
      const grup = anggotaGrupTambah.value;

      if(!nama){
        alert("Nama anggota tidak boleh kosong.");
        return;
      }

      const allMembers = [...groups.non, ...groups.sekolah];
      if(allMembers.includes(nama)){
        alert("Nama anggota sudah ada.");
        return;
      }

      groups[grup].push(nama);
      groups[grup].sort();
      saveJSON(sKey.groups, groups);
      
      alert(`Anggota "${nama}" berhasil ditambahkan ke grup ${grup === 'non' ? 'Non Sekolah' : 'Sekolah'}.`);
      anggotaNamaTambah.value = '';
      updateAnggotaSelects();
      updateUI();
      renderAllTables();
    });

    btnHapusAnggota.addEventListener('click', () => {
      const nama = anggotaNamaHapus.value;
      if(!nama){
        alert("Pilih anggota yang akan dihapus.");
        return;
      }
      if(confirm(`Yakin ingin menghapus anggota "${nama}"? Semua data absen dan fotonya akan dihapus.`)){
        // Remove from groups
        for (const grup in groups) {
          const index = groups[grup].indexOf(nama);
          if(index > -1) {
            groups[grup].splice(index, 1);
            break;
          }
        }
        // Remove from dailyData
        for (const date in dailyData) {
          delete dailyData[date][nama];
        }
        // Remove from photoMap
        delete photoMap[nama];

        saveJSON(sKey.groups, groups);
        saveJSON(sKey.daily, dailyData);
        saveJSON(sKey.photos, photoMap);
        
        alert(`Anggota "${nama}" berhasil dihapus.`);
        updateUI();
        renderAllTables();
        updateAnggotaSelects();
      }
    });

    function updateAnggotaSelects(){
      const allMembers = [...groups.non, ...groups.sekolah].sort();
      anggotaNamaHapus.innerHTML = allMembers.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
      fotoAnggotaSelect.innerHTML = allMembers.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
    }

    /* ======================= Initial Call ======================= */
    window.addEventListener('load', () => {
      datePicker.value = ymd(currentDate);
      updateAnggotaSelects();
      updateUI();
      renderAllTables();
    });
  </script>
</body>
</html>
